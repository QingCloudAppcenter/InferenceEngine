#!/usr/bin/env bash
set -e

cat > /opt/app/bin/role.sh << ROLS_SH_EOF
host="localhost"
port={{getv "/env/model.http.port" "8080"}}

prepareDir() {
  mkdir -p /data/logs && chgrp -R syslog /data/logs && chmod 775 /data/logs && mkdir -p /data/models_to_load && chmod -R +rx /opt/models && cp -rf /opt/models /data/
}

init() {
  _init
  prepareDir
  local htmlPath=/data/index.html
  [ -e \$htmlPath ] || ln -s /opt/app/conf/caddy/index.html \$htmlPath
}

start () {
  _start && cd /opt/app/bin && /usr/local/bin/docker-compose up -d && chmod -R +rx /data/logs
}

stop () {
  cd /opt/app/bin && /usr/local/bin/docker-compose down && _stop()
}

restart() {
  cd /opt/app/bin && /usr/local/bin/docker-compose down && /usr/local/bin/docker-compose up -d
}

check() {
  nc -z -w5 \$host \$port
}

revive() {
  restart
}

update() {
  return 0
}
ROLS_SH_EOF